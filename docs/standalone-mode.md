# 🏠 Maycast Recorder: Standalone Mode Specification

## 1. コンセプト定義

* **名称:** Maycast Solo / Standalone Mode
* **コアバリュー:** **"Serverless & Crash-proof"**
* サーバーを一切介さず、ブラウザ（WASM）とローカルストレージ（OPFS）だけで完結する。
* ログイン不要、完全オフライン動作対応。
* SaaS版と全く同じ「堅牢な録音エンジン」を使用する。

---

## 2. 機能要件 (Functional Requirements)

### ユーザーができること

1. **即時収録:**
   * URL（例: `/solo`）を開くだけで、ログインなしにデバイス選択・収録が可能。

2. **設定の自由:**
   * 画質設定（Stability / Quality）、マイク・カメラ選択。

3. **エクスポート:**
   * 収録終了後、`.mp4` (映像+音声) としてダウンロード。

4. **クラッシュ復元:**
   * 収録中にブラウザを誤って閉じたりクラッシュしても、再訪問時に「前回の未保存データがあります」と通知し、復元できる。

### 制限事項（SaaS版との差別化）

* **シングルユーザー限定:** 他のユーザーを招待することはできない（URL共有機能なし）。
* **クラウド同期なし:** サーバーへのアップロード処理は行われない。データはブラウザ内にのみ存在する。
* **デバイス間移動不可:** スマホで録ってPCで編集、といった連携はできない（ファイル移動が必要）。

---

## 3. 技術アーキテクチャ (Technical Specifications)

リモート版（Online Mode）から「ネットワーク送信モジュール」を外し、「ローカル結合モジュール」を足した構成になります。

### A. データフロー

1. **Capture:** `WebCodecs API` で映像/音声を取得・エンコード。
2. **Muxing (WASM):** Rust製のMuxerで **fMP4チャンク** を生成（1秒間隔）。
3. **Storage:** 生成されたチャンクを即座に **OPFS (Origin Private File System)** へ書き込む。
   * パス例: `/root/session_local_timestamp/chunk_001.m4s`

4. **Finish:** ユーザーが停止ボタンを押す。

### B. エクスポート処理 (Client-side Concatenation)

サーバーがないため、ファイルの結合をブラウザ（クライアント）側で行います。

* **課題:** 数GBのデータを一度にメモリ（RAM）に展開するとブラウザが落ちる。
* **解決策:** **Stream Processing (ストリーム処理)**
  * Rust(WASM) が OPFS からチャンクを1つずつ読み出す。
  * `ReadableStream` を作成し、結合しながらダウンロードを開始させる。
  * これにより、メモリ使用量を極小に抑えつつ、長時間の動画も出力可能。

---

## 4. UI/UX デザイン仕様

### 画面構成

シンプルさを極めます。

1. **ランディング（待機画面）:**
   * 中央に大きな波形ビジュアライザー（マイク入力確認）。
   * 下部に「REC」ボタン。
   * 右上に歯車アイコン（画質設定）。

2. **収録中画面:**
   * 経過時間タイマー。
   * 波形がリアルタイムに動く。
   * 「STOP」ボタン。
   * **ステータス表示:** 「🟢 Saving locally (OPFS active)」

3. **完了画面 (Post-Recording):**
   * プレビュープレイヤー。
   * アクションボタン：
     * `Download MP4`
     * `Discard` (削除)
     * *(将来機能: Simple Trim - 前後のカット編集)*

### リカバリーフロー (The Crash Proof UI)

ブラウザが不意に閉じられた後に、再びページを開いた時の挙動です。

1. **初期化時:** WASMが起動し、OPFS内に「Finishフラグが立っていないセッションフォルダ」がないかスキャン。
2. **検知時:** モーダルを表示。

   > **⚠️ 未保存の収録データが見つかりました**
   >
   > 前回の収録（202X/XX/XX 14:00 - 45分間）が正常に終了しませんでした。データを復元してダウンロードしますか？
   >
   > `[ 復元して保存 ]` `[ 破棄する ]`

---

## 5. 開発フェーズにおける位置づけ

このスタンドアロンモードの実装は、**Phase 1** として最優先で行います。

* **理由1:** `wasm-core`（録画エンジン）のバグ出しが単独で行えるため、デバッグ効率が良い。
* **理由2:** サーバー側の実装（WebSocket/S3）を待たずに、プロダクトとしてリリース・宣伝が可能。

**まとめ:**
スタンドアロンモードは、「機能制限版」ではなく、**「SaaS版と同じエンジンを積んだ、最強のシングルユーザー・レコーダー」**として定義します。

---

## 6. 実装チェックリスト

詳細な実装タスクは `development-plan.md` の **Phase 1** を参照。

### コア機能
- [ ] WebCodecs カメラ/マイクキャプチャ
- [ ] Rust WASM Muxer（fMP4生成）
- [ ] OPFS チャンク保存
- [ ] ストリーム処理によるエクスポート

### リカバリー機能
- [ ] OPFS未完了セッションスキャン
- [ ] IndexedDB メタデータ管理
- [ ] リカバリーモーダルUI
- [ ] 自動復元・エクスポート

### UI/UX
- [ ] ランディング画面（波形ビジュアライザー）
- [ ] 収録中画面（タイマー、ステータス）
- [ ] 完了画面（プレビュー、ダウンロード）
- [ ] 設定モーダル（デバイス、画質）

### テスト項目
- [ ] 10分以上の長時間録画
- [ ] ブラウザ強制終了からの復元
- [ ] 大容量データ（数GB）のダウンロード
- [ ] 複数デバイスでの動作確認
